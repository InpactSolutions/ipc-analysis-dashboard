<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPC Requests Analyse Dashboard</title>
    
    <!-- Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Data Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-900 { background-color: #111827; }
        .bg-white { background-color: #ffffff; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-yellow-50 { background-color: #fffbeb; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-yellow-900 { background-color: #78350f; }
        .bg-orange-100 { background-color: #ffedd5; }
        .bg-orange-900 { background-color: #9a3412; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .bg-purple-900 { background-color: #581c87; }
        .bg-cyan-100 { background-color: #cffafe; }
        .bg-cyan-900 { background-color: #164e63; }
        .bg-teal-100 { background-color: #ccfbf1; }
        .bg-teal-900 { background-color: #134e4a; }
        
        .text-white { color: #ffffff; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-900 { color: #111827; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-800 { color: #1e40af; }
        .text-blue-200 { color: #bfdbfe; }
        .text-green-600 { color: #16a34a; }
        .text-green-700 { color: #15803d; }
        .text-green-800 { color: #166534; }
        .text-green-200 { color: #bbf7d0; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-red-800 { color: #991b1b; }
        .text-orange-800 { color: #9a3412; }
        .text-orange-200 { color: #fed7aa; }
        .text-purple-800 { color: #6b21a8; }
        .text-purple-200 { color: #e9d5ff; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #854d0e; }
        .text-yellow-200 { color: #fef08a; }
        .text-cyan-800 { color: #155e75; }
        .text-cyan-200 { color: #a5f3fc; }
        .text-teal-800 { color: #115e59; }
        .text-teal-200 { color: #99f6e4; }
        
        .border { border: 1px solid #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-600 { border-color: #4b5563; }
        .border-gray-700 { border-color: #374151; }
        .border-blue-500 { border-color: #3b82f6; }
        .border-green-500 { border-color: #10b981; }
        .border-red-500 { border-color: #ef4444; }
        .border-yellow-200 { border-color: #fde68a; }
        .border-yellow-700 { border-color: #a16207; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded-t-lg { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .rounded-b-lg { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        
        .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05); }
        
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .pl-10 { padding-left: 2.5rem; }
        .pr-4 { padding-right: 1rem; }
        
        .m-2 { margin: 0.5rem; }
        .m-4 { margin: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .w-4 { width: 1rem; }
        .w-5 { width: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .w-8 { width: 2rem; }
        .w-12 { width: 3rem; }
        .w-full { width: 100%; }
        .max-w-4xl { max-width: 56rem; }
        .max-w-7xl { max-width: 80rem; }
        
        .h-2 { height: 0.5rem; }
        .h-4 { height: 1rem; }
        .h-5 { height: 1.25rem; }
        .h-6 { height: 1.5rem; }
        .h-8 { height: 2rem; }
        .h-12 { height: 3rem; }
        .min-h-screen { min-height: 100vh; }
        .max-h-32 { max-height: 8rem; }
        
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .block { display: block; }
        .inline-flex { display: inline-flex; }
        
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        
        .cursor-pointer { cursor: pointer; }
        .select-none { user-select: none; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .top-4 { top: 1rem; }
        .right-4 { right: 1rem; }
        .left-3 { left: 0.75rem; }
        .top-1\/2 { top: 50%; }
        .z-50 { z-index: 50; }
        
        .transform { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
        .-translate-y-1\/2 { --tw-translate-y: -50%; transform: translate(var(--tw-translate-x), var(--tw-translate-y)); }
        
        .transition-colors { transition: color 0.3s, background-color 0.3s, border-color 0.3s; }
        .transition-shadow { transition: box-shadow 0.3s; }
        .transition-all { transition: all 0.3s; }
        
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06); }
        
        .focus\:outline-none:focus { outline: none; }
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px #3b82f6; }
        .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px #3b82f6; }
        
        .border-l-4 { border-left-width: 4px; }
        .border-t { border-top-width: 1px; }
        .border-dashed { border-style: dashed; }
        
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .file-upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }
        
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        button {
            border: none;
            background: none;
            cursor: pointer;
            font: inherit;
        }
        
        input, select {
            font: inherit;
        }
        
        .dark {
            background-color: #111827;
            color: #f9fafb;
        }
        
        .dark .bg-white {
            background-color: #1f2937;
        }
        
        .dark .bg-gray-50 {
            background-color: #111827;
        }
        
        .dark .bg-gray-100 {
            background-color: #374151;
        }
        
        .dark .text-gray-600 {
            color: #9ca3af;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        
        .dark .text-gray-900 {
            color: #f9fafb;
        }
        
        .dark .border-gray-300 {
            border-color: #4b5563;
        }
        
        .dark .file-upload-area {
            border-color: #475569;
            background-color: #1e293b;
        }
        
        .dark .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #334155;
        }
        
        /* Custom dropdown styles */
        .dropdown-container {
            position: relative;
        }
        
        .dropdown-toggle {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dropdown-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        
        .dropdown-item.selected {
            background-color: #eff6ff;
            color: #1d4ed8;
        }
        
        .dark .dropdown-toggle {
            background-color: #374151;
            border-color: #4b5563;
            color: white;
        }
        
        .dark .dropdown-menu {
            background-color: #374151;
            border-color: #4b5563;
        }
        
        .dark .dropdown-item:hover {
            background-color: #4b5563;
        }
        
        .dark .dropdown-item.selected {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .lg\:flex-row { flex-direction: row; }
            .lg\:items-center { align-items: center; }
            .lg\:justify-between { justify-content: space-between; }
        }
        
        @media (min-width: 1280px) {
            .xl\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        function initApp() {
            if (typeof React === 'undefined') {
                console.error('React not loaded, retrying...');
                setTimeout(initApp, 100);
                return;
            }
            
            if (typeof ReactDOM === 'undefined') {
                console.error('ReactDOM not loaded, retrying...');
                setTimeout(initApp, 100);
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                console.error('XLSX not loaded, retrying...');
                setTimeout(initApp, 100);
                return;
            }
            
            if (typeof _ === 'undefined') {
                console.error('Lodash not loaded, retrying...');
                setTimeout(initApp, 100);
                return;
            }

            console.log('All libraries loaded successfully');
            
            const { useState, useEffect, useMemo, useCallback, useRef, createElement: e } = React;
            const { render } = ReactDOM;

            // Icon Components
            const Upload = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }),
                e('polyline', { key: 2, points: "17,8 12,3 7,8" }),
                e('line', { key: 3, x1: "12", x2: "12", y1: "3", y2: "15" })
            ]);

            const RefreshCw = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" }),
                e('path', { key: 2, d: "M21 3v5h-5" }),
                e('path', { key: 3, d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" }),
                e('path', { key: 4, d: "M8 16H3v5" })
            ]);

            const AlertTriangle = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" }),
                e('path', { key: 2, d: "M12 9v4" }),
                e('path', { key: 3, d: "m12 17 .01 0" })
            ]);

            const Download = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }),
                e('polyline', { key: 2, points: "7,10 12,15 17,10" }),
                e('line', { key: 3, x1: "12", x2: "12", y1: "15", y2: "3" })
            ]);

            const Filter = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('polygon', { key: 1, points: "22,3 2,3 10,12.46 10,19 14,21 14,12.46" })
            ]);

            const TrendingUp = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('polyline', { key: 1, points: "22,7 13.5,15.5 8.5,10.5 2,17" }),
                e('polyline', { key: 2, points: "16,7 22,7 22,13" })
            ]);

            const Users = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }),
                e('circle', { key: 2, cx: "9", cy: "7", r: "4" }),
                e('path', { key: 3, d: "m22 21-1.5-1.5" })
            ]);

            const Package = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "m7.5 4.27 9 5.15" }),
                e('path', { key: 2, d: "M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" }),
                e('path', { key: 3, d: "m3.3 7 8.7 5 8.7-5" }),
                e('path', { key: 4, d: "M12 22V12" })
            ]);

            const Database = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('ellipse', { key: 1, cx: "12", cy: "5", rx: "9", ry: "3" }),
                e('path', { key: 2, d: "M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5" }),
                e('path', { key: 3, d: "M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3" })
            ]);

            const Calendar = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M8 2v4" }),
                e('path', { key: 2, d: "M16 2v4" }),
                e('rect', { key: 3, width: "18", height: "18", x: "3", y: "4", rx: "2" }),
                e('path', { key: 4, d: "M3 10h18" })
            ]);

            const Eye = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" }),
                e('circle', { key: 2, cx: "12", cy: "12", r: "3" })
            ]);

            const Sun = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('circle', { key: 1, cx: "12", cy: "12", r: "4" }),
                e('path', { key: 2, d: "M12 2v2" }),
                e('path', { key: 3, d: "M12 20v2" }),
                e('path', { key: 4, d: "m4.93 4.93 1.41 1.41" }),
                e('path', { key: 5, d: "m17.66 17.66 1.41 1.41" }),
                e('path', { key: 6, d: "M2 12h2" }),
                e('path', { key: 7, d: "M20 12h2" }),
                e('path', { key: 8, d: "m6.34 17.66-1.41 1.41" }),
                e('path', { key: 9, d: "m19.07 4.93-1.41 1.41" })
            ]);

            const Moon = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" })
            ]);

            const ChevronDown = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "m6 9 6 6 6-6" })
            ]);

            const Check = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M20 6 9 17l-5-5" })
            ]);

            const FileText = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" }),
                e('path', { key: 2, d: "M14,2 14,8 20,8" }),
                e('path', { key: 3, d: "M10,9 9,9 8,9" }),
                e('path', { key: 4, d: "M16,13 8,13" }),
                e('path', { key: 5, d: "M16,17 8,17" })
            ]);

            const Share = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" }),
                e('polyline', { key: 2, points: "16,6 12,2 8,6" }),
                e('line', { key: 3, x1: "12", x2: "12", y1: "2", y2: "15" })
            ]);

            const Bookmark = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" })
            ]);

            const User = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('path', { key: 1, d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" }),
                e('circle', { key: 2, cx: "12", cy: "7", r: "4" })
            ]);

            const Image = ({ className }) => e('svg', {
                className,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24", height: "24", viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round"
            }, [
                e('rect', { key: 1, width: "18", height: "18", x: "3", y: "3", rx: "2", ry: "2" }),
                e('circle', { key: 2, cx: "9", cy: "9", r: "2" }),
                e('path', { key: 3, d: "m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" })
            ]);

            // MultiSelect Dropdown Component
            const MultiSelectDropdown = ({ 
                options, 
                selectedValues, 
                onToggle, 
                placeholder,
                darkMode,
                searchTerm,
                onSearchChange,
                maxHeight = '200px',
                showSearch = true
            }) => {
                const [isOpen, setIsOpen] = useState(false);
                const dropdownRef = useRef(null);

                useEffect(() => {
                    const handleClickOutside = (event) => {
                        if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                            setIsOpen(false);
                        }
                    };

                    document.addEventListener('mousedown', handleClickOutside);
                    return () => document.removeEventListener('mousedown', handleClickOutside);
                }, []);

                const filteredOptions = options.filter(option => 
                    option.toLowerCase().includes((searchTerm || '').toLowerCase())
                );

                return e('div', { className: 'dropdown-container', ref: dropdownRef }, [
                    e('button', {
                        key: 'toggle',
                        className: `dropdown-toggle ${darkMode ? 'dark' : ''}`,
                        onClick: () => setIsOpen(!isOpen),
                        type: 'button'
                    }, [
                        e('span', { key: 'text', className: 'text-sm' }, 
                            selectedValues.length === 0 ? placeholder : 
                            selectedValues.length === 1 ? selectedValues[0] :
                            `${selectedValues.length} geselecteerd`
                        ),
                        e(ChevronDown, { key: 'icon', className: `w-4 h-4 transition-transform ${isOpen ? 'transform rotate-180' : ''}` })
                    ]),
                    
                    isOpen && e('div', { 
                        key: 'menu',
                        className: `dropdown-menu ${darkMode ? 'dark' : ''}`,
                        style: { maxHeight }
                    }, [
                        showSearch && e('div', { key: 'search', className: 'p-2 border-b' }, [
                            e('input', {
                                type: 'text',
                                placeholder: 'Zoeken...',
                                value: searchTerm || '',
                                onChange: (e) => onSearchChange && onSearchChange(e.target.value),
                                className: `w-full px-3 py-2 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                                    darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300'
                                }`
                            })
                        ]),
                        
                        filteredOptions.length === 0 ? 
                            e('div', { key: 'empty', className: 'p-3 text-center text-gray-500 text-sm' }, 'Geen resultaten gevonden') :
                            filteredOptions.map(option => 
                                e('div', {
                                    key: option,
                                    className: `dropdown-item ${selectedValues.includes(option) ? 'selected' : ''}`,
                                    onClick: () => onToggle(option)
                                }, [
                                    e('span', { key: 'text', className: 'text-sm truncate' }, option),
                                    selectedValues.includes(option) && e(Check, { key: 'check', className: 'w-4 h-4 ml-2' })
                                ])
                            )
                    ])
                ]);
            };

            // Simple chart components
            const SimpleBarChart = ({ data, dataKey, nameKey, color = '#3b82f6', height = 300 }) => {
                if (!data || data.length === 0) return e('div', { className: 'text-center py-8 text-gray-500' }, 'Geen data beschikbaar');
                
                const maxValue = Math.max(...data.map(d => d[dataKey]));
                
                return e('div', { className: 'space-y-2', style: { height: `${height}px`, overflowY: 'auto' } },
                    data.map((item, index) => 
                        e('div', { key: index, className: 'flex items-center gap-3' }, [
                            e('div', { 
                                key: 'label', 
                                className: 'text-sm font-medium w-32 truncate', 
                                title: item[nameKey] 
                            }, item[nameKey]),
                            e('div', { key: 'bar-container', className: 'flex-1 bg-gray-200 rounded-full h-6 flex items-center' }, [
                                e('div', {
                                    key: 'bar',
                                    className: 'h-4 rounded-full transition-all duration-500',
                                    style: { 
                                        width: `${(item[dataKey] / maxValue) * 100}%`,
                                        backgroundColor: color
                                    }
                                }),
                                e('span', { 
                                    key: 'value', 
                                    className: 'ml-2 text-xs font-medium text-gray-600' 
                                }, item[dataKey].toLocaleString())
                            ])
                        ])
                    )
                );
            };

            const SimplePieChart = ({ data, dataKey, nameKey, colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'] }) => {
                if (!data || data.length === 0) return e('div', { className: 'text-center py-8 text-gray-500' }, 'Geen data beschikbaar');
                
                const total = data.reduce((sum, item) => sum + item[dataKey], 0);
                
                return e('div', { className: 'space-y-4' }, [
                    e('div', { key: 'visual', className: 'flex rounded-full overflow-hidden h-8 bg-gray-200 shadow-inner' },
                        data.map((item, index) => {
                            const percentage = (item[dataKey] / total) * 100;
                            return e('div', {
                                key: index,
                                className: 'transition-all duration-700 hover:brightness-110',
                                style: { 
                                    width: `${percentage}%`,
                                    backgroundColor: colors[index % colors.length]
                                },
                                title: `${item[nameKey]}: ${item[dataKey].toLocaleString()} (${percentage.toFixed(1)}%)`
                            });
                        })
                    ),
                    
                    e('div', { key: 'legend', className: 'grid grid-cols-1 gap-3' },
                        data.map((item, index) => {
                            const percentage = ((item[dataKey] / total) * 100).toFixed(1);
                            return e('div', { key: index, className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors' }, [
                                e('div', { key: 'info', className: 'flex items-center gap-3' }, [
                                    e('div', { 
                                        key: 'color', 
                                        className: 'w-4 h-4 rounded-full shadow-sm',
                                        style: { backgroundColor: colors[index % colors.length] }
                                    }),
                                    e('span', { key: 'name', className: 'text-sm font-medium text-gray-700' }, item[nameKey])
                                ]),
                                e('div', { key: 'stats', className: 'text-right' }, [
                                    e('div', { key: 'value', className: 'text-sm font-bold text-gray-900' }, item[dataKey].toLocaleString()),
                                    e('div', { key: 'percentage', className: 'text-xs text-gray-500' }, `${percentage}%`)
                                ])
                            ]);
                        })
                    )
                ]);
            };

            const SimpleLineChart = ({ data, dataKey, nameKey, color = '#3b82f6', height = 400 }) => {
                if (!data || data.length === 0) return e('div', { className: 'text-center py-8 text-gray-500' }, 'Geen data beschikbaar');
                
                const canvasRef = useRef(null);
                
                useEffect(() => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.getBoundingClientRect();
                    
                    // Set canvas size
                    canvas.width = rect.width * 2;
                    canvas.height = (height - 100) * 2;
                    ctx.scale(2, 2);
                    
                    const width = rect.width;
                    const chartHeight = height - 100;
                    const padding = 40;
                    const chartWidth = width - (padding * 2);
                    const chartAreaHeight = chartHeight - (padding * 2);
                    
                    // Calculate data ranges
                    const maxValue = Math.max(...data.map(d => d[dataKey]));
                    const minValue = Math.min(...data.map(d => d[dataKey]));
                    const range = maxValue - minValue;
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, width, chartHeight);
                    
                    // Draw grid
                    ctx.strokeStyle = '#f0f0f0';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= 5; i++) {
                        const y = padding + (i * chartAreaHeight / 5);
                        ctx.beginPath();
                        ctx.moveTo(padding, y);
                        ctx.lineTo(width - padding, y);
                        ctx.stroke();
                    }
                    
                    // Calculate points
                    const points = data.map((item, index) => {
                        const x = padding + (index / (data.length - 1)) * chartWidth;
                        const y = padding + chartAreaHeight - ((item[dataKey] - minValue) / range) * chartAreaHeight;
                        return { x, y, value: item[dataKey], label: item[nameKey] };
                    });
                    
                    // Draw area under line
                    ctx.fillStyle = color + '20';
                    ctx.beginPath();
                    ctx.moveTo(points[0].x, chartHeight - padding);
                    points.forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.lineTo(points[points.length - 1].x, chartHeight - padding);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Draw line
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y);
                    points.forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.stroke();
                    
                    // Draw points
                    points.forEach((point, index) => {
                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.fillStyle = 'white';
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
                        ctx.fill();
                    });
                    
                    // Draw Y-axis labels
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    for (let i = 0; i <= 5; i++) {
                        const value = minValue + (range * (5 - i) / 5);
                        const y = padding + (i * chartAreaHeight / 5);
                        ctx.fillText((value / 1000).toFixed(0) + 'k', padding - 10, y + 4);
                    }
                    
                }, [data, dataKey, height, color]);
                
                return e('div', { className: 'space-y-6' }, [
                    e('div', { key: 'chart-container', className: 'relative bg-white rounded-lg border p-4', style: { height: `${height}px` } }, [
                        e('canvas', {
                            key: 'canvas',
                            ref: canvasRef,
                            className: 'w-full cursor-crosshair',
                            style: { height: `${height - 100}px` }
                        }),
                        e('div', { key: 'x-labels', className: 'flex justify-between px-10 mt-2' },
                            data.map((item, index) => 
                                e('div', { 
                                    key: index, 
                                    className: 'text-xs text-gray-600 text-center transform -rotate-45 origin-center',
                                    style: { fontSize: '11px' }
                                }, item[nameKey])
                            )
                        )
                    ])
                ]);
            };

            // Advanced Export & Reporting Component
            const ExportReportingPanel = ({ data, filteredData, stats, darkMode, filters, onLoadView, addNotification }) => {
                const [isOpen, setIsOpen] = useState(false);
                const [selectedExportType, setSelectedExportType] = useState('excel');
                const [savedViews, setSavedViews] = useState([]);
                const [viewName, setViewName] = useState('');
                
                useEffect(() => {
                    try {
                        const stored = JSON.parse(sessionStorage.getItem('ipc-saved-views') || '[]');
                        setSavedViews(stored);
                    } catch (error) {
                        console.log('No saved views found');
                        setSavedViews([]);
                    }
                }, []);

                useEffect(() => {
                    try {
                        sessionStorage.setItem('ipc-saved-views', JSON.stringify(savedViews));
                    } catch (error) {
                        console.error('Could not save views');
                    }
                }, [savedViews]);
                
                const exportTypes = [
                    { id: 'excel', label: 'Excel Spreadsheet', icon: Database, description: 'Volledige data export' },
                    { id: 'csv', label: 'CSV Data', icon: Download, description: 'Comma-separated values' }
                ];

                const saveCurrentView = () => {
                    if (!viewName.trim()) {
                        addNotification('error', 'Voer een naam in voor deze view');
                        return;
                    }
                    
                    if (savedViews.some(view => view.name === viewName.trim())) {
                        addNotification('error', 'Deze naam bestaat al. Kies een andere naam.');
                        return;
                    }
                    
                    const newView = {
                        id: Date.now(),
                        name: viewName.trim(),
                        filters: { ...filters },
                        created: new Date().toLocaleDateString('nl-NL'),
                        recordCount: filteredData.length
                    };
                    
                    setSavedViews(prev => [...prev, newView]);
                    setViewName('');
                    addNotification('success', `View "${newView.name}" opgeslagen`);
                };

                const loadSavedView = (view) => {
                    if (onLoadView) {
                        onLoadView(view.filters);
                        addNotification('success', `View "${view.name}" geladen`);
                        setIsOpen(false);
                    }
                };

                const generateCSVExport = () => {
                    const csvHeaders = ['Environment', 'YyyyMm', 'Insurer', 'Product', 'Gebruiker_Genormaliseerd', 'Gebruiker_Origineel', 'Bron', 'IsLeverancier', 'Aantal'];
                    const csvRows = filteredData.map(row => [
                        row.Environment,
                        row.YyyyMm ? row.YyyyMm.toISOString().split('T')[0] : '',
                        row.Insurer,
                        row.Product,
                        row.normalizedUser,
                        row.actualUser,
                        row.userSource,
                        row.isLeverancier ? 'Ja' : 'Nee',
                        row.Aantal
                    ]);
                    
                    const csvContent = [csvHeaders, ...csvRows]
                        .map(row => row.map(cell => `"${cell}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `IPC_Data_Cascading_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    addNotification('success', 'CSV bestand met cascading filters gedownload');
                };

                if (!isOpen) {
                    return e('button', {
                        onClick: () => setIsOpen(true),
                        className: `flex items-center gap-2 px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-green-600 hover:bg-green-700'} text-white transition-colors`
                    }, [
                        e(Share, { key: 'icon', className: 'w-4 h-4' }),
                        e('span', { key: 'text' }, 'Export & Rapportage')
                    ]);
                }

                return e('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4' }, [
                    e('div', { 
                        key: 'modal',
                        className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto`
                    }, [
                        e('div', { key: 'header', className: 'flex items-center justify-between p-6 border-b' }, [
                            e('h2', { key: 'title', className: 'text-2xl font-bold flex items-center gap-3' }, [
                                e(Share, { className: 'w-6 h-6 text-blue-600' }),
                                'Export & Rapportage'
                            ]),
                            e('button', {
                                key: 'close',
                                onClick: () => setIsOpen(false),
                                className: 'text-gray-500 hover:text-gray-700 text-2xl'
                            }, '×')
                        ]),

                        e('div', { key: 'content', className: 'p-6 space-y-8' }, [
                            e('div', { key: 'export-types' }, [
                                e('h3', { className: 'text-lg font-semibold mb-4' }, 'Export Formaat'),
                                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                    exportTypes.map(type => 
                                        e('div', {
                                            key: type.id,
                                            onClick: () => setSelectedExportType(type.id),
                                            className: `p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                                                selectedExportType === type.id 
                                                    ? 'border-blue-500 bg-blue-50' 
                                                    : 'border-gray-200 hover:border-gray-300'
                                            }`
                                        }, [
                                            e('div', { key: 'header', className: 'flex items-center gap-3 mb-2' }, [
                                                e(type.icon, { className: 'w-5 h-5 text-blue-600' }),
                                                e('span', { className: 'font-medium' }, type.label)
                                            ]),
                                            e('p', { key: 'desc', className: 'text-sm text-gray-600' }, type.description)
                                        ])
                                    )
                                )
                            ]),

                            e('div', { key: 'save-view' }, [
                                e('h3', { className: 'text-lg font-semibold mb-4 flex items-center gap-2' }, [
                                    e(Bookmark, { className: 'w-5 h-5' }),
                                    'Huidige View Opslaan'
                                ]),
                                e('div', { className: 'flex gap-3' }, [
                                    e('input', {
                                        type: 'text',
                                        placeholder: 'Naam voor deze view...',
                                        value: viewName,
                                        onChange: (e) => setViewName(e.target.value),
                                        className: `flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                                            darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                                        }`
                                    }),
                                    e('button', {
                                        onClick: saveCurrentView,
                                        className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                    }, 'Opslaan')
                                ])
                            ]),

                            savedViews.length > 0 && e('div', { key: 'saved-views' }, [
                                e('h3', { className: 'text-lg font-semibold mb-4' }, 'Opgeslagen Views'),
                                e('div', { className: 'space-y-2' },
                                    savedViews.map(view =>
                                        e('div', {
                                            key: view.id,
                                            className: 'flex items-center justify-between p-3 border rounded-lg'
                                        }, [
                                            e('div', { key: 'info' }, [
                                                e('div', { className: 'font-medium' }, view.name),
                                                e('div', { className: 'text-sm text-gray-600' }, 
                                                    `${view.recordCount.toLocaleString()} records • ${view.created}`
                                                )
                                            ]),
                                            e('button', {
                                                key: 'load',
                                                onClick: () => loadSavedView(view),
                                                className: 'px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded transition-colors'
                                            }, 'Laden')
                                        ])
                                    )
                                )
                            ])
                        ]),

                        e('div', { key: 'footer', className: 'flex items-center justify-between p-6 border-t bg-gray-50' }, [
                            e('div', { key: 'spacer' }),
                            e('div', { key: 'actions', className: 'flex gap-3' }, [
                                e('button', {
                                    onClick: () => setIsOpen(false),
                                    className: 'px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors'
                                }, 'Annuleren'),
                                e('button', {
                                    onClick: () => {
                                        if (selectedExportType === 'excel') {
                                            const wb = XLSX.utils.book_new();
                                            const ws = XLSX.utils.json_to_sheet(filteredData);
                                            XLSX.utils.book_append_sheet(wb, ws, 'IPC Data');
                                            XLSX.writeFile(wb, `IPC_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
                                            addNotification('success', 'Excel bestand gedownload');
                                        } else if (selectedExportType === 'csv') {
                                            generateCSVExport();
                                        }
                                        setIsOpen(false);
                                    },
                                    className: 'px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                }, 'Exporteren')
                            ])
                        ])
                    ])
                ]);
            };

            // Main Component
            const IpcAnalysisTool = () => {
                const [data, setData] = useState([]);
                const [filteredData, setFilteredData] = useState([]);
                const [loading, setLoading] = useState(false);
                const [darkMode, setDarkMode] = useState(false);
                const [fileUploaded, setFileUploaded] = useState(false);
                const [uploadError, setUploadError] = useState(null);
                const [notifications, setNotifications] = useState([]);
                const [searchTerms, setSearchTerms] = useState({
                    user: '',
                    environment: '',
                    insurer: '',
                    product: '',
                    leverancier: '',
                    veUser: ''
                });
                const [filters, setFilters] = useState({
                    environment: [],
                    insurer: [],
                    product: [],
                    user: [],
                    leverancier: [],
                    veUser: [],
                    selectedYear: 'all',
                    selectedMonth: 'all'
                });
                const [uniqueValues, setUniqueValues] = useState({
                    environments: [],
                    insurers: [],
                    products: [],
                    users: [],
                    leveranciers: [],
                    years: [],
                    months: []
                });

                const fileInputRef = useRef(null);

                // Helper functions
                const normalizeUserName = (userName) => {
                    if (!userName || userName === 'NULL') return 'Unknown';
                    
                    // Remove numbers and common suffixes from user names
                    let normalized = userName.toString().trim();
                    
                    // Specific mappings for the requested companies
                    const companyMappings = {
                        'AWI B.V.': /^AWI B\.V\.(\s+\d+)?$/i,
                        'CCS Testbedrijf 1': /^CCS Testbedrijf 1(\s+\d+)?$/i,
                        'Comparity B.V.': /^Comparity B\.V\.(\s+\d+)?$/i,
                        'DIAS Software B.V.': /^DIAS Software B\.V\.(\s+\d+)?$/i,
                        'Fish testbedrijf1': /^Fish testbedrijf\d*(\s+\d+)?$/i,
                        'My TP B.V.': /^My TP B\.V\.(\s+\d+)?$/i,
                        'SECTOR ORANGE B.V.': /^SECTOR ORANGE B\.V\.(\s+\d+)?$/i,
                        'Volmachtbeheer B.V.': /^Volmachtbeheer B\.V\.(\s+\d+)?$/i
                    };
                    
                    // Check if the username matches any of our specific patterns
                    for (const [cleanName, pattern] of Object.entries(companyMappings)) {
                        if (pattern.test(normalized)) {
                            return cleanName;
                        }
                    }
                    
                    // General cleanup: remove trailing numbers and common patterns
                    normalized = normalized
                        .replace(/\s+\d+$/, '') // Remove trailing numbers
                        .replace(/\s+$/, ''); // Remove trailing spaces
                    
                    return normalized;
                };

                const isLeverancier = (normalizedUserName) => {
                    const leveranciers = [
                        'AWI B.V.',
                        'CCS Testbedrijf 1',
                        'Comparity B.V.',
                        'DIAS Software B.V.',
                        'Fish testbedrijf1',
                        'My TP B.V.',
                        'SECTOR ORANGE B.V.',
                        'Volmachtbeheer B.V.'
                    ];
                    
                    return leveranciers.includes(normalizedUserName);
                };

                const categorizeUser = (user, aantal) => {
                    if (!user || user === 'NULL') return 'Unknown';
                    if (aantal > 10000) return 'Enterprise';
                    if (aantal > 1000) return 'Large';
                    if (aantal > 100) return 'Medium';
                    return 'Small';
                };

                const categorizeProduct = (product) => {
                    if (!product) return 'Unknown';
                    if (product.toLowerCase().includes('auto')) return 'Auto';
                    if (product.toLowerCase().includes('woning')) return 'Property';
                    if (product.toLowerCase().includes('aansprakelijk')) return 'Liability';
                    return 'Other';
                };

                const calculateCompleteness = (row) => {
                    const fields = ['Environment', 'YyyyMm', 'Engine', 'Insurer', 'Product', 'Gebruiker', 'Aantal'];
                    const validFields = fields.filter(field => row[field] && row[field] !== 'NULL' && row[field] !== null);
                    return (validFields.length / fields.length) * 100;
                };

                // File upload handler
                const handleFileUpload = async (file) => {
                    if (!file) return;

                    try {
                        setLoading(true);
                        setUploadError(null);
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, {
                            cellStyles: true,
                            cellFormulas: true,
                            cellDates: true,
                            cellNF: true,
                            sheetStubs: true
                        });

                        if (!workbook.SheetNames.includes('Data')) {
                            throw new Error('Excel bestand moet een "Data" sheet bevatten');
                        }

                        const dataSheet = workbook.Sheets['Data'];
                        const rawData = XLSX.utils.sheet_to_json(dataSheet);
                        
                        if (rawData.length === 0) {
                            throw new Error('Data sheet is leeg');
                        }

                        console.log('Raw data length:', rawData.length);

                        const processedData = rawData.map((row, index) => {
                            const date = row.YyyyMm ? new Date(row.YyyyMm) : null;
                            const monthNames = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
                            
                            // Smart user combination logic with normalization
                            let actualUser = row.Gebruiker;
                            let userSource = 'Gebruiker';
                            
                            // If GebruikerVe exists and is not empty/null/placeholder, use it
                            if (row.GebruikerVe && 
                                row.GebruikerVe !== '(geen VE_MYAAND)' && 
                                row.GebruikerVe.trim() !== '' && 
                                row.GebruikerVe !== 'NULL') {
                                actualUser = row.GebruikerVe;
                                userSource = 'GebruikerVe';
                            }
                            
                            // Normalize the user name to combine similar entries
                            const normalizedUser = normalizeUserName(actualUser);
                            
                            // Create display name showing source (but use normalized name)
                            const userDisplayName = userSource === 'GebruikerVe' ? 
                                `${normalizedUser} (VE)` : 
                                `${normalizedUser} (Reg)`;
                            
                            return {
                                ...row,
                                id: index,
                                YyyyMm: date,
                                Aantal: parseInt(row.Aantal) || 0,
                                month: date ? `${monthNames[date.getMonth()]} ${date.getFullYear()}` : 'Onbekend',
                                monthKey: date ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : 'unknown',
                                year: date ? date.getFullYear() : 'Onbekend',
                                actualUser: actualUser, // Keep original for reference
                                normalizedUser: normalizedUser, // Add normalized version
                                isLeverancier: isLeverancier(normalizedUser), // Flag if this is a leverancier
                                userSource: userSource,
                                userDisplayName: userDisplayName, // This now uses normalized name
                                userCategory: categorizeUser(normalizedUser, row.Aantal),
                                productCategory: categorizeProduct(row.Product),
                                hasValidDate: !!date,
                                hasValidUser: !!normalizedUser && normalizedUser !== 'Unknown',
                                completeness: calculateCompleteness(row)
                            };
                        });

                        console.log('Processed data length:', processedData.length);

                        setData(processedData);
                        setFilteredData(processedData);

                        const allEnvironments = _.uniq(processedData.map(d => d.Environment)).filter(Boolean);
                        const allInsurers = _.uniq(processedData.map(d => d.Insurer)).filter(Boolean).sort();
                        const allProducts = _.uniq(processedData.map(d => d.Product)).filter(Boolean).sort();
                        // Separate regular users from leveranciers
                        const allUsers = _.uniq(processedData.filter(d => !d.isLeverancier).map(d => d.userDisplayName)).filter(Boolean).sort();
                        const allLeveranciers = _.uniq(processedData.filter(d => d.isLeverancier).map(d => d.userDisplayName)).filter(Boolean).sort();
                        const allYears = _.uniq(processedData.filter(d => d.YyyyMm).map(d => d.YyyyMm.getFullYear())).sort().reverse();

                        setUniqueValues({
                            environments: allEnvironments,
                            insurers: allInsurers,
                            products: allProducts,
                            users: allUsers,
                            leveranciers: allLeveranciers,
                            years: allYears,
                            months: [
                                { value: 1, label: 'Januari' },
                                { value: 2, label: 'Februari' },
                                { value: 3, label: 'Maart' },
                                { value: 4, label: 'April' },
                                { value: 5, label: 'Mei' },
                                { value: 6, label: 'Juni' },
                                { value: 7, label: 'Juli' },
                                { value: 8, label: 'Augustus' },
                                { value: 9, label: 'September' },
                                { value: 10, label: 'Oktober' },
                                { value: 11, label: 'November' },
                                { value: 12, label: 'December' }
                            ]
                        });

                        setFileUploaded(true);
                        addNotification('success', `${processedData.length.toLocaleString()} records succesvol geladen`);
                        
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setUploadError(error.message);
                        addNotification('error', `Fout bij laden: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                };

                // Get filtered products based on selected insurers
                const getFilteredProducts = () => {
                    if (filters.insurer.length === 0) {
                        return [];
                    }
                    
                    const filteredByInsurer = data.filter(d => filters.insurer.includes(d.Insurer));
                    const products = _.uniq(filteredByInsurer.map(d => d.Product)).filter(Boolean).sort();
                    return products;
                };

                // Get filtered users based on selected insurers and products (excluding leveranciers)
                const getFilteredUsers = () => {
                    let baseData = data.filter(d => !d.isLeverancier); // Exclude leveranciers
                    
                    // Only filter by insurer if insurers are selected
                    if (filters.insurer.length > 0) {
                        baseData = baseData.filter(d => filters.insurer.includes(d.Insurer));
                    }
                    // Only filter by product if products are selected
                    if (filters.product.length > 0) {
                        baseData = baseData.filter(d => filters.product.includes(d.Product));
                    }
                    
                    const users = _.uniq(baseData.map(d => d.userDisplayName)).filter(Boolean).sort();
                    return users;
                };

                // Get VE users linked to selected leveranciers
                const getLinkedVEUsers = () => {
                    if (filters.leverancier.length === 0) {
                        return [];
                    }
                    
                    // Get the normalized names of selected leveranciers (without (REG)/(VE) suffix)
                    const selectedLeverancierNames = filters.leverancier.map(leverancier => 
                        leverancier.replace(/\s+\((REG|VE)\)$/, '')
                    );
                    
                    // Find all VE users that are linked to these leveranciers
                    const linkedVEUsers = data.filter(d => {
                        // Check if this is a VE user
                        if (d.userSource !== 'GebruikerVe') return false;
                        
                        // Check if the normalized name matches any selected leverancier
                        const normalizedName = d.normalizedUser;
                        return selectedLeverancierNames.includes(normalizedName);
                    });
                    
                    return _.uniq(linkedVEUsers.map(d => d.userDisplayName)).filter(Boolean).sort();
                };

                // Notification system
                const addNotification = (type, message) => {
                    const id = Date.now();
                    setNotifications(prev => [...prev, { id, type, message, timestamp: new Date() }]);
                    setTimeout(() => {
                        setNotifications(prev => prev.filter(n => n.id !== id));
                    }, 5000);
                };

                // Apply filters
                const applyFilters = useCallback(() => {
                    let filtered = [...data];

                    if (filters.environment.length > 0) {
                        filtered = filtered.filter(d => filters.environment.includes(d.Environment));
                    }
                    if (filters.insurer.length > 0) {
                        filtered = filtered.filter(d => filters.insurer.includes(d.Insurer));
                    }
                    if (filters.product.length > 0) {
                        filtered = filtered.filter(d => filters.product.includes(d.Product));
                    }
                    if (filters.user.length > 0) {
                        filtered = filtered.filter(d => filters.user.includes(d.userDisplayName));
                    }
                    if (filters.leverancier.length > 0) {
                        filtered = filtered.filter(d => filters.leverancier.includes(d.userDisplayName));
                    }
                    if (filters.veUser.length > 0) {
                        filtered = filtered.filter(d => filters.veUser.includes(d.userDisplayName));
                    }

                    if (filters.selectedYear !== 'all') {
                        filtered = filtered.filter(d => d.YyyyMm && d.YyyyMm.getFullYear() === parseInt(filters.selectedYear));
                    }
                    if (filters.selectedMonth !== 'all') {
                        filtered = filtered.filter(d => d.YyyyMm && (d.YyyyMm.getMonth() + 1) === parseInt(filters.selectedMonth));
                    }

                    setFilteredData(filtered);
                }, [data, filters]);

                useEffect(() => {
                    applyFilters();
                }, [applyFilters]);

                // Statistics
                const stats = useMemo(() => {
                    const totalRequests = filteredData.reduce((sum, d) => sum + d.Aantal, 0);
                    // Use normalized user names for unique count
                    const uniqueUsers = _.uniq(filteredData.map(d => d.normalizedUser)).filter(u => u !== 'Unknown').length;
                    const uniqueProducts = _.uniq(filteredData.map(d => d.Product)).length;
                    const uniqueInsurers = _.uniq(filteredData.map(d => d.Insurer)).length;
                    const avgPerMonth = filteredData.length > 0 ? Math.round(totalRequests / _.uniq(filteredData.map(d => d.month)).length) : 0;
                    const dataQuality = _.mean(filteredData.map(d => d.completeness)) || 0;

                    return {
                        totalRequests,
                        uniqueUsers,
                        uniqueProducts,
                        uniqueInsurers,
                        avgPerMonth,
                        totalRecords: filteredData.length,
                        dataQuality
                    };
                }, [filteredData]);

                // Chart data
                const getMonthlyData = () => {
                    const grouped = _.groupBy(filteredData.filter(d => d.YyyyMm), d => {
                        const date = new Date(d.YyyyMm);
                        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    });
                    
                    return Object.entries(grouped)
                        .map(([monthKey, records]) => {
                            const [year, month] = monthKey.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
                            const monthName = monthNames[parseInt(month) - 1];
                            
                            return {
                                month: `${monthName} ${year}`,
                                monthKey: monthKey,
                                requests: records.reduce((sum, r) => sum + r.Aantal, 0),
                                records: records.length,
                                sortDate: new Date(parseInt(year), parseInt(month) - 1, 1)
                            };
                        })
                        .sort((a, b) => a.sortDate - b.sortDate)
                        .slice(-12);
                };

                const getInsurerData = () => {
                    const grouped = _.groupBy(filteredData, 'Insurer');
                    return Object.entries(grouped)
                        .map(([insurer, records]) => ({
                            insurer,
                            requests: records.reduce((sum, r) => sum + r.Aantal, 0),
                            records: records.length
                        }))
                        .sort((a, b) => b.requests - a.requests)
                        .slice(0, 10);
                };

                const getProductData = () => {
                    const grouped = _.groupBy(filteredData, 'Product');
                    return Object.entries(grouped)
                        .map(([product, records]) => ({
                            product: product.length > 25 ? product.substring(0, 25) + '...' : product,
                            fullProduct: product,
                            requests: records.reduce((sum, r) => sum + r.Aantal, 0),
                            records: records.length
                        }))
                        .sort((a, b) => b.requests - a.requests)
                        .slice(0, 10);
                };

                const getUserData = () => {
                    // Group by normalized user display name to combine similar entries
                    const grouped = _.groupBy(filteredData, 'userDisplayName');
                    return Object.entries(grouped)
                        .map(([user, records]) => ({
                            user: user.length > 30 ? user.substring(0, 30) + '...' : user,
                            fullUser: user,
                            requests: records.reduce((sum, r) => sum + r.Aantal, 0),
                            records: records.length,
                            // Add additional info for tooltip
                            originalUsers: _.uniq(records.map(r => r.actualUser)).join(', ')
                        }))
                        .sort((a, b) => b.requests - a.requests)
                        .slice(0, 15);
                };

                const getEnvironmentData = () => {
                    const grouped = _.groupBy(filteredData, 'Environment');
                    return Object.entries(grouped)
                        .map(([env, records]) => ({
                            environment: env,
                            requests: records.reduce((sum, r) => sum + r.Aantal, 0),
                            records: records.length,
                            share: (records.reduce((sum, r) => sum + r.Aantal, 0) / filteredData.reduce((sum, r) => sum + r.Aantal, 0)) * 100
                        }));
                };

                const handleMultiSelectFilter = (type, value) => {
                    setFilters(prev => {
                        const newFilters = { ...prev };
                        
                        if (newFilters[type].includes(value)) {
                            newFilters[type] = newFilters[type].filter(v => v !== value);
                        } else {
                            newFilters[type] = [...newFilters[type], value];
                        }
                        
                        // Clear dependent filters when changing insurer
                        if (type === 'insurer') {
                            newFilters.product = [];
                            // Don't clear users or leveranciers when changing insurer
                        }
                        
                        // Clear VE users when leverancier selection changes
                        if (type === 'leverancier') {
                            newFilters.veUser = [];
                        }
                        
                        return newFilters;
                    });
                };

                // Load saved view function
                const loadSavedView = useCallback((savedFilters) => {
                    setFilters(savedFilters);
                    addNotification('success', 'View geladen');
                }, []);

                // File upload component
                const FileUploadArea = () => {
                    const [dragOver, setDragOver] = useState(false);

                    const handleDrop = (event) => {
                        event.preventDefault();
                        setDragOver(false);
                        const files = event.dataTransfer.files;
                        if (files.length > 0) {
                            handleFileUpload(files[0]);
                        }
                    };

                    const handleDragOver = (event) => {
                        event.preventDefault();
                        setDragOver(true);
                    };

                    const handleDragLeave = (event) => {
                        event.preventDefault();
                        setDragOver(false);
                    };

                    return e('div', 
                        {
                            className: `file-upload-area ${dragOver ? 'drag-over' : ''}`,
                            onDrop: handleDrop,
                            onDragOver: handleDragOver,
                            onDragLeave: handleDragLeave,
                            onClick: () => fileInputRef.current?.click()
                        },
                        e('div', { className: 'flex flex-col items-center gap-4' }, [
                            e(Upload, { key: 'icon', className: 'w-12 h-12 text-gray-400' }),
                            e('div', { key: 'text', className: 'text-center' }, [
                                e('p', { key: 'title', className: 'text-lg font-medium text-gray-700' }, 'Upload IPC Data Excel Bestand'),
                                e('p', { key: 'subtitle', className: 'text-sm text-gray-600 mt-1' }, 'Sleep het bestand hierheen of klik om te selecteren'),
                                e('p', { key: 'requirement', className: 'text-xs text-gray-400 mt-2' }, 'Excel bestand moet een "Data" sheet bevatten')
                            ]),
                            e('input', {
                                key: 'input',
                                ref: fileInputRef,
                                type: 'file',
                                accept: '.xlsx,.xls',
                                onChange: (event) => {
                                    if (event.target.files.length > 0) {
                                        handleFileUpload(event.target.files[0]);
                                    }
                                },
                                className: 'hidden'
                            })
                        ])
                    );
                };

                useEffect(() => {
                    if (darkMode) {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                }, [darkMode]);

                if (!fileUploaded) {
                    return e('div', 
                        { className: `min-h-screen transition-colors ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'} p-6` },
                        [
                            e('div', { key: 'notifications', className: 'fixed top-4 right-4 z-50 space-y-2' },
                                notifications.map(notification =>
                                    e('div',
                                        {
                                            key: notification.id,
                                            className: `p-3 rounded-lg shadow-lg border-l-4 animate-slide-in ${
                                                notification.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' :
                                                notification.type === 'success' ? 'bg-green-50 border-green-500 text-green-700' :
                                                'bg-blue-50 border-blue-500 text-blue-700'
                                            }`
                                        },
                                        e('span', { className: 'text-sm font-medium' }, notification.message)
                                    )
                                )
                            ),
                            
                            e('div', { key: 'main', className: 'max-w-4xl mx-auto' }, [
                                e('div', 
                                    { key: 'header', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-8 mb-8 text-center` },
                                    [
                                        e('h1', 
                                            { key: 'title', className: 'text-4xl font-bold mb-4 text-blue-600' },
                                            'IPC Requests Analyse Dashboard'
                                        ),
                                        e('p', 
                                            { key: 'subtitle', className: `${darkMode ? 'text-gray-300' : 'text-gray-600'} text-xl mb-6` },
                                            'Upload je Excel bestand om geavanceerde analyses te starten'
                                        ),
                                        e('div', { key: 'actions', className: 'flex justify-center gap-4' }, [
                                            e('button',
                                                {
                                                    key: 'dark-toggle',
                                                    onClick: () => setDarkMode(!darkMode),
                                                    className: `p-3 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors`
                                                },
                                                darkMode ? e(Sun, { className: 'w-6 h-6' }) : e(Moon, { className: 'w-6 h-6' })
                                            )
                                        ])
                                    ]
                                ),

                                e('div', 
                                    { key: 'upload', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-8 mb-8` },
                                    loading ? 
                                        e('div', { key: 'loading', className: 'text-center py-12' }, [
                                            e(RefreshCw, { key: 'spinner', className: 'w-12 h-12 animate-spin mx-auto mb-4 text-blue-600' }),
                                            e('p', { key: 'text', className: 'text-lg' }, 'Bestand wordt verwerkt...')
                                        ])
                                        :
                                        e(FileUploadArea, { key: 'upload-area' })
                                ),

                                uploadError && e('div', 
                                    { key: 'error', className: 'bg-red-50 border border-red-200 rounded-lg p-6 mb-8' },
                                    e('div', { className: 'flex items-center gap-3' }, [
                                        e(AlertTriangle, { key: 'icon', className: 'w-6 h-6 text-red-600' }),
                                        e('div', { key: 'text' }, [
                                            e('h3', { key: 'title', className: 'font-medium text-red-800' }, 'Upload Fout'),
                                            e('p', { key: 'message', className: 'text-red-600 mt-1' }, uploadError)
                                        ])
                                    ])
                                )
                            ])
                        ]
                    );
                }

                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

                return e('div', 
                    { className: `min-h-screen transition-colors ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'} p-6` },
                    [
                        e('div', { key: 'notifications', className: 'fixed top-4 right-4 z-50 space-y-2' },
                            notifications.map(notification =>
                                e('div',
                                    {
                                        key: notification.id,
                                        className: `p-3 rounded-lg shadow-lg border-l-4 animate-slide-in ${
                                            notification.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' :
                                            notification.type === 'success' ? 'bg-green-50 border-green-500 text-green-700' :
                                            'bg-blue-50 border-blue-500 text-blue-700'
                                        }`
                                    },
                                    e('span', { className: 'text-sm font-medium' }, notification.message)
                                )
                            )
                        ),

                        e('div', { key: 'main', className: 'max-w-7xl mx-auto' }, [
                            e('div', 
                                { key: 'header', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6 mb-6` },
                                e('div', { className: 'flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4' }, [
                                    e('div', { key: 'title-section' }, [
                                        e('h1', 
                                            { className: 'text-3xl font-bold mb-2 text-blue-600' },
                                            'IPC Requests Analyse Dashboard'
                                        ),
                                        e('p', 
                                            { className: `${darkMode ? 'text-gray-300' : 'text-gray-600'}` },
                                            `Analyseer ${data.length.toLocaleString()} records | Data kwaliteit: ${stats.dataQuality.toFixed(1)}%`
                                        )
                                    ]),
                                    e('div', { key: 'actions', className: 'flex items-center gap-3' }, [
                                        e('button',
                                            {
                                                onClick: () => setDarkMode(!darkMode),
                                                className: `p-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors`
                                            },
                                            darkMode ? e(Sun, { className: 'w-5 h-5' }) : e(Moon, { className: 'w-5 h-5' })
                                        ),
                                        e(ExportReportingPanel, {
                                            key: 'export',
                                            data: data,
                                            filteredData: filteredData,
                                            stats: stats,
                                            darkMode: darkMode,
                                            filters: filters,
                                            onLoadView: loadSavedView,
                                            addNotification: addNotification
                                        })
                                    ])
                                ])
                            ),

                            e('div', 
                                { key: 'filters', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6 mb-6` },
                                [
                                    e('div', { key: 'filter-header', className: 'flex items-center gap-2 mb-4' }, [
                                        e(Filter, { className: 'w-5 h-5 text-gray-600' }),
                                        e('h2', { className: 'text-lg font-semibold' }, 'Geavanceerde Filters')
                                    ]),
                                    e('div', { key: 'filter-content', className: 'space-y-4' }, [
                                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4' }, [
                                            e('div', { key: 'env-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2' }, 'Environment'),
                                                e(MultiSelectDropdown, {
                                                    options: uniqueValues.environments,
                                                    selectedValues: filters.environment,
                                                    onToggle: (value) => handleMultiSelectFilter('environment', value),
                                                    placeholder: 'Selecteer environments...',
                                                    darkMode: darkMode,
                                                    searchTerm: searchTerms.environment,
                                                    onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, environment: term })),
                                                    showSearch: uniqueValues.environments.length > 5
                                                })
                                            ]),

                                            e('div', { key: 'insurer-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2' }, 'Verzekeraar'),
                                                e(MultiSelectDropdown, {
                                                    options: uniqueValues.insurers,
                                                    selectedValues: filters.insurer,
                                                    onToggle: (value) => handleMultiSelectFilter('insurer', value),
                                                    placeholder: 'Selecteer verzekeraars...',
                                                    darkMode: darkMode,
                                                    searchTerm: searchTerms.insurer,
                                                    onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, insurer: term })),
                                                    showSearch: uniqueValues.insurers.length > 5
                                                })
                                            ]),

                                            e('div', { key: 'product-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2' }, 'Product'),
                                                filters.insurer.length === 0 ? 
                                                    e('div', { className: `px-3 py-2 text-sm text-gray-500 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}` },
                                                        'Selecteer eerst verzekeraar'
                                                    ) :
                                                    e(MultiSelectDropdown, {
                                                        options: getFilteredProducts(),
                                                        selectedValues: filters.product,
                                                        onToggle: (value) => handleMultiSelectFilter('product', value),
                                                        placeholder: 'Selecteer producten...',
                                                        darkMode: darkMode,
                                                        searchTerm: searchTerms.product,
                                                        onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, product: term })),
                                                        showSearch: getFilteredProducts().length > 5
                                                    })
                                            ]),

                                            e('div', { key: 'user-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2 flex items-center gap-2' }, [
                                                    e(User, { className: 'w-4 h-4' }),
                                                    'Gebruiker'
                                                ]),
                                                e(MultiSelectDropdown, {
                                                    options: getFilteredUsers(),
                                                    selectedValues: filters.user,
                                                    onToggle: (value) => handleMultiSelectFilter('user', value),
                                                    placeholder: 'Selecteer gebruikers...',
                                                    darkMode: darkMode,
                                                    searchTerm: searchTerms.user,
                                                    onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, user: term })),
                                                    showSearch: true,
                                                    maxHeight: '250px'
                                                })
                                            ]),

                                            e('div', { key: 'leverancier-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2 flex items-center gap-2' }, [
                                                    e(Package, { className: 'w-4 h-4' }),
                                                    'Leverancier'
                                                ]),
                                                e(MultiSelectDropdown, {
                                                    options: uniqueValues.leveranciers,
                                                    selectedValues: filters.leverancier,
                                                    onToggle: (value) => handleMultiSelectFilter('leverancier', value),
                                                    placeholder: 'Selecteer leveranciers...',
                                                    darkMode: darkMode,
                                                    searchTerm: searchTerms.leverancier,
                                                    onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, leverancier: term })),
                                                    showSearch: true,
                                                    maxHeight: '250px'
                                                })
                                            ]),

                                            e('div', { key: 've-user-filter' }, [
                                                e('label', { className: 'block text-sm font-medium mb-2 flex items-center gap-2' }, [
                                                    e(Users, { className: 'w-4 h-4' }),
                                                    'VE Gebruiker'
                                                ]),
                                                filters.leverancier.length === 0 ? 
                                                    e('div', { className: `px-3 py-2 text-sm text-gray-500 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'}` },
                                                        'Selecteer eerst leverancier'
                                                    ) :
                                                    e(MultiSelectDropdown, {
                                                        options: getLinkedVEUsers(),
                                                        selectedValues: filters.veUser,
                                                        onToggle: (value) => handleMultiSelectFilter('veUser', value),
                                                        placeholder: 'Selecteer VE gebruikers...',
                                                        darkMode: darkMode,
                                                        searchTerm: searchTerms.veUser,
                                                        onSearchChange: (term) => setSearchTerms(prev => ({ ...prev, veUser: term })),
                                                        showSearch: true,
                                                        maxHeight: '250px'
                                                    })
                                            ]),

                                            e('div', { key: 'date-filters', className: 'space-y-3' }, [
                                                e('div', { key: 'year-filter' }, [
                                                    e('label', { className: 'block text-sm font-medium mb-2' }, 'Jaar'),
                                                    e('select', {
                                                        value: filters.selectedYear,
                                                        onChange: (event) => setFilters(prev => ({ ...prev, selectedYear: event.target.value })),
                                                        className: `w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                                                            darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                                                        }`
                                                    }, [
                                                        e('option', { key: 'all-years', value: 'all' }, 'Alle jaren'),
                                                        ...uniqueValues.years.map(year =>
                                                            e('option', { key: year, value: year.toString() }, year.toString())
                                                        )
                                                    ])
                                                ]),
                                                e('div', { key: 'month-filter' }, [
                                                    e('label', { className: 'block text-sm font-medium mb-2' }, 'Maand'),
                                                    e('select', {
                                                        value: filters.selectedMonth,
                                                        onChange: (event) => setFilters(prev => ({ ...prev, selectedMonth: event.target.value })),
                                                        className: `w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                                                            darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                                                        }`
                                                    }, [
                                                        e('option', { key: 'all-months', value: 'all' }, 'Alle maanden'),
                                                        ...uniqueValues.months.map(month =>
                                                            e('option', { key: month.value, value: month.value.toString() }, month.label)
                                                        )
                                                    ])
                                                ])
                                            ])
                                        ]),
                                        
                                        e('div', { key: 'user-legend', className: 'mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200' }, [
                                            e('h4', { className: 'text-sm font-semibold text-blue-800 mb-2' }, 'Gebruiker Legenda:'),
                                            e('div', { className: 'flex flex-wrap gap-4 text-xs' }, [
                                                e('div', { key: 'reg', className: 'flex items-center gap-2' }, [
                                                    e('span', { className: 'px-2 py-1 bg-blue-100 text-blue-800 rounded' }, '(Reg)'),
                                                    e('span', { className: 'text-blue-700' }, 'Reguliere gebruiker uit "Gebruiker" veld')
                                                ]),
                                                e('div', { key: 've', className: 'flex items-center gap-2' }, [
                                                    e('span', { className: 'px-2 py-1 bg-green-100 text-green-800 rounded' }, '(VE)'),
                                                    e('span', { className: 'text-green-700' }, 'VE gebruiker uit "GebruikerVe" veld')
                                                ])
                                            ])
                                        ])
                                    ])
                                ]
                            ),

                            e('div', 
                                { key: 'stats', className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-6' },
                                [
                                    {
                                        title: 'Totaal Requests',
                                        value: stats.totalRequests.toLocaleString(),
                                        icon: TrendingUp,
                                        color: 'blue'
                                    },
                                    {
                                        title: 'Unieke Gebruikers',
                                        value: stats.uniqueUsers.toLocaleString(),
                                        icon: Users,
                                        color: 'green'
                                    },
                                    {
                                        title: 'Producten',
                                        value: stats.uniqueProducts,
                                        icon: Package,
                                        color: 'purple'
                                    },
                                    {
                                        title: 'Verzekeraars',
                                        value: stats.uniqueInsurers,
                                        icon: Database,
                                        color: 'orange'
                                    },
                                    {
                                        title: 'Gem. per Maand',
                                        value: stats.avgPerMonth.toLocaleString(),
                                        icon: Calendar,
                                        color: 'pink'
                                    },
                                    {
                                        title: 'Data Kwaliteit',
                                        value: `${stats.dataQuality.toFixed(1)}%`,
                                        icon: Eye,
                                        color: 'cyan'
                                    }
                                ].map((stat, index) =>
                                    e('div', 
                                        { 
                                            key: index,
                                            className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-4 border-l-4 border-blue-500 hover:shadow-md transition-shadow`
                                        },
                                        e('div', { className: 'flex items-center justify-between' }, [
                                            e('div', { key: 'content' }, [
                                                e('p', 
                                                    { className: `text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}` },
                                                    stat.title
                                                ),
                                                e('p', { className: 'text-2xl font-bold mt-1' }, stat.value)
                                            ]),
                                            e(stat.icon, { key: 'icon', className: 'w-8 h-8 text-blue-600' })
                                        ])
                                    )
                                )
                            ),

                            e('div', { key: 'charts', className: 'grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6' }, [
                                e('div', 
                                    { key: 'monthly', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6` },
                                    [
                                        e('h3', { key: 'title', className: 'text-lg font-semibold mb-4' }, 'Maandelijkse Trend'),
                                        e(SimpleLineChart, { 
                                            key: 'chart',
                                            data: getMonthlyData(), 
                                            dataKey: 'requests', 
                                            nameKey: 'month', 
                                            color: '#3b82f6',
                                            height: 400
                                        })
                                    ]
                                ),

                                e('div', 
                                    { key: 'environment', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6` },
                                    [
                                        e('h3', { key: 'title', className: 'text-lg font-semibold mb-4' }, 'Environment Verdeling'),
                                        e(SimplePieChart, { 
                                            key: 'chart',
                                            data: getEnvironmentData(), 
                                            dataKey: 'requests', 
                                            nameKey: 'environment', 
                                            colors: colors 
                                        })
                                    ]
                                )
                            ]),

                            e('div', { key: 'performers', className: 'grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6' }, [
                                e('div', 
                                    { key: 'insurers', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6` },
                                    [
                                        e('h3', { key: 'title', className: 'text-lg font-semibold mb-4' }, 'Top 10 Verzekeraars'),
                                        e(SimpleBarChart, { 
                                            key: 'chart',
                                            data: getInsurerData(), 
                                            dataKey: 'requests', 
                                            nameKey: 'insurer', 
                                            color: '#10b981' 
                                        })
                                    ]
                                ),

                                e('div', 
                                    { key: 'products', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6` },
                                    [
                                        e('h3', { key: 'title', className: 'text-lg font-semibold mb-4' }, 'Top 10 Producten'),
                                        e(SimpleBarChart, { 
                                            key: 'chart',
                                            data: getProductData(), 
                                            dataKey: 'requests', 
                                            nameKey: 'product', 
                                            color: '#f59e0b' 
                                        })
                                    ]
                                )
                            ]),

                            e('div', 
                                { key: 'users', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6 mb-6` },
                                [
                                    e('h3', { key: 'title', className: 'text-lg font-semibold mb-4 flex items-center gap-2' }, [
                                        e(User, { className: 'w-5 h-5' }),
                                        'Top 15 Gebruikers (Genormaliseerd & Gecombineerd)'
                                    ]),
                                    e('div', { key: 'info', className: 'mb-4 p-3 bg-green-50 rounded-lg border border-green-200' }, [
                                        e('p', { className: 'text-sm text-green-700' }, [
                                            e('strong', { key: 'bold' }, 'Automatische Combinatie: '),
                                            'Gebruikers met gelijkaardige namen (zoals "AWI B.V." en "AWI B.V. 120959") worden automatisch samengevoegd voor een overzichtelijkere analyse.'
                                        ])
                                    ]),
                                    e(SimpleBarChart, { 
                                        key: 'chart',
                                        data: getUserData(), 
                                        dataKey: 'requests', 
                                        nameKey: 'user', 
                                        color: '#8b5cf6',
                                        height: 400
                                    })
                                ]
                            ),

                            e('div', 
                                { key: 'footer', className: `${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-sm p-6` },
                                e('div', { className: 'flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4' }, [
                                    e('div', { key: 'actions', className: 'flex items-center gap-4' }, [
                                        e('button',
                                            {
                                                onClick: () => window.location.reload(),
                                                className: 'flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                            },
                                            [
                                                e(RefreshCw, { key: 'icon', className: 'w-4 h-4' }),
                                                e('span', { key: 'text' }, 'Vernieuw Data')
                                            ]
                                        )
                                    ]),
                                    
                                    e('div', { key: 'info', className: 'flex items-center gap-4 text-sm text-gray-500' }, [
                                        e('span', { key: 'update' }, `Laatste update: ${new Date().toLocaleString('nl-NL')}`),
                                        e('span', { key: 'sep1' }, '•'),
                                        e('span', { key: 'records' }, `${filteredData.length.toLocaleString()} van ${data.length.toLocaleString()} records`),
                                        e('span', { key: 'sep2' }, '•'),
                                        e('span', { key: 'version' }, 'v2.0')
                                    ])
                                ])
                            )
                        ])
                    ]
                );
            };

            render(e(IpcAnalysisTool), document.getElementById('root'));
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
